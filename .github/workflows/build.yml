- name: Install depot_tools
  run: |
    git config --global core.autocrlf false
    git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
    echo "${{ github.workspace }}/depot_tools" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
  shell: pwsh

- name: Verify essential depot_tools scripts exist
  run: |
    $scripts = @("fetch.bat", "gclient.bat", "gn.bat", "vpython3.bat")
    foreach ($s in $scripts) {
      if (-not (Test-Path "${{ github.workspace }}\depot_tools\$s")) {
        Write-Error "Missing: $s"
        exit 1
      }
    }
    Write-Host "âœ… depot_tools scripts verified."
  shell: pwsh

- name: Set environment variables
  run: |
    echo "DEPOT_TOOLS_WIN_TOOLCHAIN=0" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV
  shell: pwsh

- name: Fetch WebRTC source
  run: |
    & "${{ github.workspace }}\depot_tools\fetch.bat" --nohooks webrtc
    if (-not (Test-Path "${{ github.workspace }}\src")) {
      Write-Error "Fetch did not create src/"
      exit 1
    }
  shell: pwsh

- name: Sync dependencies
  run: |
    & "${{ github.workspace }}\depot_tools\gclient.bat" sync --nohooks
  shell: pwsh

- name: Generate build files
  run: |
    cd src
    & "${{ github.workspace }}\depot_tools\gn.bat" gen out/Default --args="is_debug=false target_cpu=\"x64\""
  shell: pwsh

- name: Build video_replay
  run: |
    cd src
    & "${{ github.workspace }}\depot_tools\ninja.exe" -C out/Default video_replay
  shell: pwsh
