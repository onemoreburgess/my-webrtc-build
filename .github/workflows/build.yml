name: Build video_replay for Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史（确保 git describe 可用）

      - name: Configure Git for depot_tools
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git config --global core.filemode false
          git config --global core.fscache true
          git config --global core.preloadindex true
          git config --global depot-tools.allowGlobalGitConfig false

      - name: Install depot_tools
        shell: pwsh
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "${{ github.workspace }}/depot_tools" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH

      - name: Verify essential depot_tools scripts exist
        shell: pwsh
        run: |
          $scripts = @("fetch.bat", "gclient.bat", "gn.bat", "vpython3.bat")
          foreach ($s in $scripts) {
            $path = "${{ github.workspace }}\depot_tools\$s"
            if (-not (Test-Path $path)) {
              Write-Error "FATAL: Missing required script: $s"
              exit 1
            }
          }

      - name: Set environment variables
        shell: pwsh
        run: |
          echo "DEPOT_TOOLS_WIN_TOOLCHAIN=0" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV

      - name: Fetch WebRTC source
        shell: pwsh
        run: |
          $retry = 0
          while ($retry -lt 3) {
            & "${{ github.workspace }}\depot_tools\fetch.bat" webrtc  # 注意：不再加 --nohooks
            if ($LASTEXITCODE -eq 0) { break }
            $retry++
            Write-Host "Fetch failed. Retry $retry in 15s..."
            Start-Sleep -Seconds 15
          }
          if ($retry -eq 3) {
            Write-Error "Fetch failed after 3 attempts."
            exit 1
          }
          if (-not (Test-Path "${{ github.workspace }}\src")) {
            Write-Error "FATAL: 'src' directory missing!"
            exit 1
          }

      - name: Sync dependencies (WITH hooks)
        shell: pwsh
        run: |
          $retry = 0
          while ($retry -lt 3) {
            & "${{ github.workspace }}\depot_tools\gclient.bat" sync  # 移除 --nohooks！
            if ($LASTEXITCODE -eq 0) { break }
            $retry++
            Write-Host "gclient sync failed. Retry $retry in 15s..."
            Start-Sleep -Seconds 15
          }
          if ($retry -eq 3) {
            Write-Error "gclient sync failed after 3 attempts."
            exit 1
          }

      - name: Generate build files with GN
        shell: cmd
        run: |
          cd src
          "%GITHUB_WORKSPACE%\depot_tools\gn.bat" gen out/Default --args="is_debug=false is_component_build=false target_cpu=\"x64\""
          if %ERRORLEVEL% NEQ 0 (
            echo GN generation failed.
            exit /b 1
          )
          echo ✅ Build files generated.

      - name: Build video_replay
        shell: cmd
        run: |
          cd src
          "%GITHUB_WORKSPACE%\depot_tools\ninja.exe" -C out/Default video_replay
          if %ERRORLEVEL% NEQ 0 (
            echo Build failed.
            exit /b 1
          )
          echo ✅ Build succeeded.

      - name: Verify output
        shell: pwsh
        run: |
          $exe = "${{ github.workspace }}\src\out\Default\video_replay.exe"
          if (-not (Test-Path $exe)) {
            Write-Error "video_replay.exe not found!"
            exit 1
          }
          Write-Host "✅ Build successful! Size: $([math]::Round((Get-Item $exe).Length / 1MB, 2)) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: video_replay-windows-x64
          path: src/out/Default/video_replay.exe
