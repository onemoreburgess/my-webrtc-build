name: Build video_replay for Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git and Install depot_tools
        run: |
          # 防止 .bat 文件被 Git 换行符转换破坏
          git config --global core.autocrlf false
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "${{ github.workspace }}/depot_tools" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
        shell: pwsh

      - name: Verify depot_tools content (debug)
        run: |
          Write-Host "Listing depot_tools directory:"
          dir "${{ github.workspace }}\depot_tools"
          if (-not (Test-Path "${{ github.workspace }}\depot_tools\vpython.bat")) {
            Write-Error "FATAL: vpython.bat is missing! Clone may have failed."
            exit 1
          }
        shell: pwsh

      - name: Install Python dependencies (fallback for gclient)
        run: |
          python -m pip install --upgrade pip
          python -m pip install PySocks httplib2 urllib3 certifi six colorama
        shell: pwsh

      - name: Set environment variables
        run: |
          echo "DEPOT_TOOLS_WIN_TOOLCHAIN=0" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV
          echo "GYP_MSVS_OVERRIDE_PATH=C:\\Program Files\\Microsoft Visual Studio\\2022\\Enterprise" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV
        shell: pwsh

      - name: Fetch WebRTC source (with retry)
        run: |
          mkdir webrtc
          cd webrtc
          $retry = 0
          while ($retry -lt 3) {
            & "${{ github.workspace }}\depot_tools\vpython.bat" fetch --nohooks webrtc
            if ($LASTEXITCODE -eq 0) { break }
            $retry++
            Write-Host "Fetch failed. Retry $retry in 15s..."
            Start-Sleep -Seconds 15
          }
          if ($retry -eq 3) { exit 1 }
        shell: pwsh

      - name: Sync dependencies
        run: |
          cd webrtc
          $retry = 0
          while ($retry -lt 3) {
            & "${{ github.workspace }}\depot_tools\vpython.bat" gclient sync --nohooks --retry 5
            if ($LASTEXITCODE -eq 0) { break }
            $retry++
            Write-Host "Sync failed. Retry $retry in 15s..."
            Start-Sleep -Seconds 15
          }
          if ($retry -eq 3) { exit 1 }
        shell: pwsh

      - name: Generate build files with GN
        run: |
          cd webrtc/src
          & "${{ github.workspace }}\depot_tools\gn.bat" gen out/Default --args="is_debug=false is_component_build=false target_cpu=\"x64\""
        shell: pwsh

      - name: Build video_replay
        run: |
          cd webrtc/src
          & "${{ github.workspace }}\depot_tools\ninja.exe" -C out/Default video_replay
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: video_replay-windows-x64
          path: webrtc/src/out/Default/video_replay.exe
